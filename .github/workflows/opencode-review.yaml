name: OpenCode Review

on:
  pull_request:
    types: [opened, synchronize]

concurrency:
  group: opencode-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  opencode-review:
    # Skip review for automated "Version Packages" PRs created by changesets
    if: github.event.pull_request.title == 'OpencodeReviewTest'

    timeout-minutes: 30
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Fetch PR diff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Pre-fetch the full PR diff
          gh pr diff ${{ github.event.pull_request.number }} > /tmp/pr-diff.patch
          echo "PR diff: $(wc -l < /tmp/pr-diff.patch) lines"

      - name: Install OpenCode
        run: curl -fsSL https://opencode.ai/install | bash
      #...
      - name: Run OpenCode Review
        env:
          #ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}anthropic/claude-sonnet-4-20250514
          GH_TOKEN: ${{ github.token }}
          OPENCODE_PERMISSION: '{ "bash": { "*": "deny", "gh api:*": "allow" }, "external_directory": { "/tmp/*": "allow" } }'
        run: |
          opencode run -m opencode/glm-4.7-free "You are reviewing PRs for the Cloudflare Sandbox SDK.

          Repository: ${{ github.repository }}
          PR Number: ${{ github.event.pull_request.number }}

          **Read these docs first**:
          - AGENTS.md - development workflow and coding standards
          - docs/ARCHITECTURE.md - three-layer architecture and request flow
          - docs/CONCURRENCY.md - concurrency model (read before flagging any race conditions)

          **BE CONCISE**: Only report actual issues worth addressing. Skip generic praise and obvious observations. If PR looks good, say so briefly.

          ### 1. Build Context (Before Looking at Diff)

          **Understand the domain first**:
          - Use mcp__cloudflare-docs__search_cloudflare_documentation to understand relevant Cloudflare concepts related to this change
          - Ask: 'What files/modules interact with the changed code? How is this pattern used elsewhere?'

          **Then review the diff with that context.**

          ### 2. Check for Previous Review (Internal Context Only)

          Your previous feedback has been pre-fetched in two places:

          **Top-level review comments** (your main '## OpenCode Review' posts):
          Read /tmp/previous-comments.json

          **Inline code comments** (your comments on specific lines):
          Read /tmp/review-threads.json

          **What changed since your last review:**
          Read /tmp/review-context.json

          Read all three to understand what you've already said and what's changed.
          **Don't announce 'Update N'** - just write naturally, like continuing a conversation.

          ### 3. Gather Context

          PR metadata and diff have been pre-fetched. Read these files:
          Read /tmp/pr-metadata.json   # title, body, baseBranch, headBranch, author
          Read /tmp/pr-diff.patch      # Full PR diff

          Also read AGENTS.md for repo-specific conventions and architecture patterns.

          ### 4. Check Documentation Impact
          Use mcp__cloudflare-docs__search_cloudflare_documentation to check if this PR requires doc updates:
          - Does it change existing documented behavior?
          - Does it add new features needing documentation?
          - Does it have security implications needing best practices docs?
          - If yes, call out specific doc sections that need updates

          ### 5. Internal Analysis
          Before writing your review, analyze:
          a. What is this PR accomplishing?
          b. Which packages/layers are affected?
          c. Are there architectural or security implications? (If flagging race conditions, verify against docs/CONCURRENCY.md first)
          d. What tests are needed?
          e. Does this need documentation updates?

          ### 6. Decide What to Do With Your Previous Inline Comments

          You already read /tmp/review-threads.json in step 2. Now decide for each thread: was it fixed, or does it need follow-up?

          This decision informs your new review - mention progress naturally:
          - 'The encoding issue is fixed, thanks!'
          - 'Still seeing the over-mocking - I'll follow up on that thread.'

          Don't duplicate thread content in your new review. Reference it instead.

          ### 7. Post Review

          **Writing style**:
          - Be direct. One clear point per issue.
          - Skip praise, acknowledgments, and preambles.
          - If PR is good: 'Looks good' and stop.
          - If issues found: State the issue, reference location, explain why it matters. Move on.

          **Format**:
          - **Inline comments**: Use for specific line-by-line code issues (file path, line number, comment)
          - **Main comment**: Summary only - overall assessment, architectural concerns, testing strategy, verdict. Do NOT duplicate inline comments here.

          **Main comment - write like a human reviewer:**
          - Start with '## OpenCode Review'
          - Acknowledge progress on previous feedback: 'The encoding issue is fixed, nice!'
          - Reference ongoing threads: 'Still discussing the mocking approach in that thread.'
          - Raise new concerns: 'New issue: error handling in container.ts doesn't cover...'
          - Give a clear verdict: 'Looks good to merge' or 'A few things to address first'

          **Submit your review**

          Create review.json with your main comment and any NEW inline comments (don't re-comment on existing threads):
          {
            \"body\": \"## OpenCode Review\n\nYour overall assessment...\",
            \"event\": \"COMMENT\",
            \"commit_id\": \"${{ github.event.pull_request.head.sha }}\",
            \"comments\": [
              {\"path\": \"path/to/file.ts\", \"line\": 42, \"body\": \"New issue here\"}
            ]
          }

          Post it:
          gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews --method POST --input review.json

          **Handle your existing inline threads**

          For each thread from step 6, decide: is the issue fixed or does it need follow-up?

          **If fixed** -> resolve it using Write tool:
          Write /tmp/threads-to-resolve.txt with thread IDs (one per line)

          **If needs follow-up** -> reply using Write tool:
          Write /tmp/thread-replies.json with JSON array: [{\"commentId\": 123456789, \"body\": \"...\"}]

          You can also reply AND resolve (e.g., 'Fixed, thanks!' then resolve).
          Subsequent workflow steps will submit these automatically."

      - name: Resolve review threads
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Resolve threads that OpenCode marked for resolution
          if [ -f /tmp/threads-to-resolve.txt ]; then
            while read -r thread_id; do
              if [ -n "$thread_id" ]; then
                echo "Resolving thread: $thread_id"
                gh api graphql -f query='
                  mutation($threadId: ID!) {
                    resolveReviewThread(input: {threadId: $threadId}) {
                      thread { id isResolved }
                    }
                  }' -f threadId="$thread_id" || echo "Failed to resolve $thread_id (may already be resolved)"
              fi
            done < /tmp/threads-to-resolve.txt
            echo "Done resolving $(wc -l < /tmp/threads-to-resolve.txt | tr -d ' ') threads"
          else
            echo "No threads to resolve"
          fi
